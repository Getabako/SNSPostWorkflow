name: InstagramæŠ•ç¨¿ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”Ÿæˆ

on:
  # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯
  workflow_dispatch:
    inputs:
      calendar_days:
        description: 'ç”Ÿæˆã™ã‚‹æŠ•ç¨¿æ—¥æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 30æ—¥ï¼‰'
        required: false
        type: number
        default: 30
      generate_images:
        description: 'ç”»åƒã‚‚è‡ªå‹•ç”Ÿæˆã™ã‚‹ï¼ˆGemini APIä½¿ç”¨ï¼‰'
        required: false
        type: boolean
        default: false

  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼ˆæ¯æœˆ1æ—¥ã®åˆå‰9æ™‚ JST = åˆå‰0æ™‚ UTCï¼‰
  schedule:
    - cron: '0 0 1 * *'

  # ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ãŒæ›´æ–°ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
  push:
    branches:
      - main
    paths:
      - 'index.html'

jobs:
  generate-content:
    runs-on: ubuntu-latest

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-mplus
          echo "ğŸ“ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ•ã‚©ãƒ³ãƒˆä¸€è¦§:"
          fc-list | grep -i "noto\|mplus" | head -20

      # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
      - name: å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
        run: |
          mkdir -p output/images

      # ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸è§£æ
      - name: ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’è§£æ
        run: npm run analyze-homepage

      # æŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆ
      - name: æŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç”Ÿæˆ
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          CALENDAR_DAYS: ${{ github.event.inputs.calendar_days || '1' }}
        run: npm run generate-calendar

      # ç”»åƒè‡ªå‹•ç”Ÿæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ç”»åƒã‚’è‡ªå‹•ç”Ÿæˆ
        if: ${{ github.event.inputs.generate_images == 'true' || github.event_name == 'push' }}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: npm run generate-images

      # ç”»åƒåˆæˆã¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: ç”»åƒã«ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆæˆã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: ${{ github.event.inputs.generate_images == 'true' || github.event_name == 'push' }}
        run: npm run compose-images

      # ç”Ÿæˆç‰©ã‚’Artifactã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ç”Ÿæˆç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        with:
          name: instagram-calendar-${{ github.run_number }}
          path: |
            output/calendar.csv
            output/business-summary.txt
            output/images/
            output/composed/
          retention-days: 90

      # çµæœã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: çµæœã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if [[ -n $(git status -s output/) ]]; then
            git add output/
            git commit -m "ğŸ¤– è‡ªå‹•ç”Ÿæˆ: InstagramæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ $(date '+%Y-%m-%d')"
            git push
          else
            echo "å¤‰æ›´ãŒãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi

      # å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      - name: å®Œäº†
        run: |
          echo "âœ… InstagramæŠ•ç¨¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”Ÿæˆå®Œäº†"
          if [ "${{ github.event.inputs.generate_images }}" == "true" ]; then
            echo "ğŸ–¼ï¸  ç”»åƒã‚‚è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
            echo "ğŸ¨ ãƒ†ã‚­ã‚¹ãƒˆåˆæˆæ¸ˆã¿ç”»åƒãŒimages.if-juku.netã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ"
            echo "ğŸ“‹ Artifactã‹ã‚‰ calendar.csvã€images/ã€composed/ ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"
          else
            echo "ğŸ“‹ Artifactã‹ã‚‰ calendar.csv ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"
          fi
